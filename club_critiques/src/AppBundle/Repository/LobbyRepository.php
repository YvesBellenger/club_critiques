<?php

namespace AppBundle\Repository;
use AppBundle\Entity\Content;

/**
 * LobbyRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class LobbyRepository extends \Doctrine\ORM\EntityRepository
{
    public function getLobbyHistory() {
        $qb = $this->createQueryBuilder('l');
        $qb->where('l.date_end < :date')
            ->setParameter('date', date('Y-m-d H:i:s'));

        return $qb->getQuery()
            ->getResult();
    }

    public function getLobbiesByFilters($category, $author, $title) {
        $qb = $this->createQueryBuilder('l');
        $qb->leftJoin(Content::class, 'c', 'WITH', 'c = l.content')
            ->where('l.date_start > :date');
        if ($category) {
            $qb->andWhere('c.category = :category');
            $qb->setParameter('category', $category);

        }
        if ($author) {
            $qb->andWhere('c.author = :author')
                ->setParameter('author', $author);
        }
        $qb->andWhere('c.title LIKE :title')
            ->andWhere('l.status = 1')
            ->setParameter('date', date('Y-m-d H:i:s'))
            ->setParameter('title', '%'.$title.'%');
        return $qb->getQuery()
            ->getResult();
    }
}
